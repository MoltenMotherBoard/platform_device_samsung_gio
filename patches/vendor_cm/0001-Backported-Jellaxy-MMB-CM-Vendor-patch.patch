From 647719a31247d94afb9def3ca36d60b63c5bb235 Mon Sep 17 00:00:00 2001
From: streambinder <davidepucci@hiddenhost.org>
Date: Fri, 27 Jun 2014 00:03:48 +0200
Subject: [PATCH] Backported Jellaxy&MMB CM Vendor patch

---
 CHANGELOG.mkdn                    |   3 +
 README.mkdn                       |   2 +-
 config/common.mk                  |  36 +++-------
 config/common_mini.mk             | 142 ++++++++++++++++++++++++++++++++++++++
 config/common_mini_phone.mk       |  12 ++--
 get-prebuilts                     |   2 -
 jenkins-build-targets             |  20 ++----
 prebuilt/common/etc/init.local.rc |  14 ----
 tools/squisher                    |  14 +++-
 vendorsetup.sh                    |   2 +-
 10 files changed, 179 insertions(+), 68 deletions(-)
 create mode 100644 config/common_mini.mk

diff --git a/CHANGELOG.mkdn b/CHANGELOG.mkdn
index 4da80ff..721efc3 100644
--- a/CHANGELOG.mkdn
+++ b/CHANGELOG.mkdn
@@ -9,6 +9,9 @@ Follow http://twitter.com/cmsrc for commit-by-commit updates.
 
 CHANGELOG (notable new features)
 ---------
+### 9.1.5 (by MoltenMotherBoard)
+* Stability improved
+* Lots of stuff (good tests :P)
 
 ### 9.1.0
 * Common: Things and Stuff (I swear we will fill this out much better later on)
diff --git a/README.mkdn b/README.mkdn
index fcb5c99..fd07708 100644
--- a/README.mkdn
+++ b/README.mkdn
@@ -29,7 +29,7 @@ Getting Started
 To get started with Android/CyanogenMod, you'll need to get
 familiar with [Git and Repo](http://source.android.com/download/using-repo).
 
-To initialize your local repository using the CyanogenMod trees, use a command like this:
+To initialize your local repository using the Jellaxy/CyanogenMod trees, use a command like this:
 
     repo init -u git://github.com/CyanogenMod/android.git -b ics
 
diff --git a/config/common.mk b/config/common.mk
index 22617ef..4c68deb 100644
--- a/config/common.mk
+++ b/config/common.mk
@@ -5,13 +5,8 @@ ifneq ($(TARGET_BOOTANIMATION_NAME),)
         vendor/cm/prebuilt/common/bootanimation/$(TARGET_BOOTANIMATION_NAME).zip:system/media/bootanimation.zip
 endif
 
-ifdef CM_NIGHTLY
-PRODUCT_PROPERTY_OVERRIDES += \
-    ro.rommanager.developerid=cyanogenmodnightly
-else
 PRODUCT_PROPERTY_OVERRIDES += \
-    ro.rommanager.developerid=cyanogenmod
-endif
+    ro.rommanager.developerid=mmb
 
 PRODUCT_BUILD_PROP_OVERRIDES += BUILD_UTC_DATE=0
 
@@ -44,25 +39,21 @@ PRODUCT_COPY_FILES += \
 PRODUCT_COPY_FILES += \
     vendor/cm/prebuilt/common/etc/init.d/90userinit:system/etc/init.d/90userinit
 
-# CM-specific init file
-PRODUCT_COPY_FILES += \
-    vendor/cm/prebuilt/common/etc/init.local.rc:root/init.cm.rc
-
 # Compcache/Zram support
 PRODUCT_COPY_FILES += \
+    vendor/cm/prebuilt/common/etc/init.local.rc:system/etc/init.local.rc \
     vendor/cm/prebuilt/common/bin/compcache:system/bin/compcache \
     vendor/cm/prebuilt/common/bin/handle_compcache:system/bin/handle_compcache
 
+# Nam configuration script
+PRODUCT_COPY_FILES += \
+    vendor/cm/prebuilt/common/bin/modelid_cfg.sh:system/bin/modelid_cfg.sh
+
 PRODUCT_COPY_FILES +=  \
     vendor/cm/proprietary/Term.apk:system/app/Term.apk \
     vendor/cm/proprietary/lib/armeabi/libjackpal-androidterm4.so:system/lib/libjackpal-androidterm4.so \
 	vendor/cm/prebuilt/common/apps/Superuser.apk:system/app/Superuser.apk
 
-# Bring in camera effects
-PRODUCT_COPY_FILES +=  \
-    vendor/cm/prebuilt/common/media/LMprec_508.emd:system/media/LMprec_508.emd \
-    vendor/cm/prebuilt/common/media/PFFprec_600.emd:system/media/PFFprec_600.emd
-
 # Enable SIP+VoIP on all targets
 PRODUCT_COPY_FILES += \
     frameworks/base/data/etc/android.software.sip.voip.xml:system/etc/permissions/android.software.sip.voip.xml
@@ -88,28 +79,17 @@ PRODUCT_PACKAGES += \
 
 # Optional CM packages
 PRODUCT_PACKAGES += \
-    VideoEditor \
     VoiceDialer \
     SoundRecorder \
     Basic \
-    HoloSpiralWallpaper \
-    MagicSmokeWallpapers \
-    NoiseField \
-    Galaxy4 \
-    LiveWallpapers \
-    LiveWallpapersPicker \
-    VisualizationWallpapers \
-    PhaseBeam
+    LiveWallpapersPicker
 
 # Custom CM packages
 PRODUCT_PACKAGES += \
     Trebuchet \
     DSPManager \
     libcyanogen-dsp \
-    audio_effects.conf \
-    CMWallpapers \
-    Apollo \
-    CMUpdater
+    audio_effects.conf
 
 # Extra tools in CM
 PRODUCT_PACKAGES += \
diff --git a/config/common_mini.mk b/config/common_mini.mk
new file mode 100644
index 0000000..b374186
--- /dev/null
+++ b/config/common_mini.mk
@@ -0,0 +1,142 @@
+PRODUCT_BRAND ?= cyanogenmod
+
+ifneq ($(TARGET_BOOTANIMATION_NAME),)
+    PRODUCT_COPY_FILES += \
+        vendor/cm/prebuilt/common/bootanimation/$(TARGET_BOOTANIMATION_NAME).zip:system/media/bootanimation.zip
+endif
+
+PRODUCT_PROPERTY_OVERRIDES += \
+    ro.rommanager.developerid=mmb
+
+PRODUCT_BUILD_PROP_OVERRIDES += BUILD_UTC_DATE=0
+
+PRODUCT_PROPERTY_OVERRIDES += \
+    keyguard.no_require_sim=true \
+    ro.url.legal=http://www.google.com/intl/%s/mobile/android/basic/phone-legal.html \
+    ro.url.legal.android_privacy=http://www.google.com/intl/%s/mobile/android/basic/privacy.html \
+    ro.com.google.clientidbase=android-google \
+    ro.com.android.wifi-watchlist=GoogleGuest \
+    ro.setupwizard.enterprise_mode=1 \
+    ro.com.android.dateformat=MM-dd-yyyy \
+    ro.com.android.dataroaming=false
+
+# Arabic languages
+$(call inherit-product, build/target/product/locales_full.mk)
+
+# Copy over the changelog to the device
+PRODUCT_COPY_FILES += \
+    vendor/cm/CHANGELOG.mkdn:system/etc/CHANGELOG-CM.txt
+
+# Backup Tool
+PRODUCT_COPY_FILES += \
+    vendor/cm/prebuilt/common/bin/backuptool.sh:system/bin/backuptool.sh \
+    vendor/cm/prebuilt/common/bin/backuptool.functions:system/bin/backuptool.functions \
+    vendor/cm/prebuilt/common/bin/50-cm.sh:system/addon.d/50-cm.sh
+
+# init.d support
+PRODUCT_COPY_FILES += \
+    vendor/cm/prebuilt/common/etc/init.d/00banner:system/etc/init.d/00banner \
+    vendor/cm/prebuilt/common/bin/sysinit:system/bin/sysinit
+
+# userinit support
+PRODUCT_COPY_FILES += \
+    vendor/cm/prebuilt/common/etc/init.d/90userinit:system/etc/init.d/90userinit
+
+# Compcache/Zram support
+PRODUCT_COPY_FILES += \
+    vendor/cm/prebuilt/common/etc/init.local.rc:root/init.local.rc \
+    vendor/cm/prebuilt/common/bin/compcache:system/bin/compcache \
+    vendor/cm/prebuilt/common/bin/handle_compcache:system/bin/handle_compcache
+
+PRODUCT_COPY_FILES +=  \
+    vendor/cm/proprietary/Term.apk:system/app/Term.apk \
+    vendor/cm/proprietary/lib/armeabi/libjackpal-androidterm4.so:system/lib/libjackpal-androidterm4.so \
+    vendor/cm/prebuilt/common/apps/Superuser.apk:system/app/Superuser.apk
+
+# Bring in camera effects
+PRODUCT_COPY_FILES +=  \
+    vendor/cm/prebuilt/common/media/LMprec_508.emd:system/media/LMprec_508.emd \
+    vendor/cm/prebuilt/common/media/PFFprec_600.emd:system/media/PFFprec_600.emd
+
+# Enable SIP+VoIP on all targets
+PRODUCT_COPY_FILES += \
+    frameworks/base/data/etc/android.software.sip.voip.xml:system/etc/permissions/android.software.sip.voip.xml
+
+# This is CM!
+PRODUCT_COPY_FILES += \
+    vendor/cm/config/permissions/com.cyanogenmod.android.xml:system/etc/permissions/com.cyanogenmod.android.xml
+
+# Don't export PS1 in /system/etc/mkshrc.
+PRODUCT_COPY_FILES += \
+    vendor/cm/prebuilt/common/etc/mkshrc:system/etc/mkshrc
+
+# T-Mobile theme engine
+include vendor/cm/config/themes_common.mk
+
+# Required CM packages
+PRODUCT_PACKAGES += \
+    Camera \
+    Development \
+    LatinIME \
+    SpareParts \
+    su
+
+#    Superuser \
+#    Superuser.apk \
+
+# Optional CM packages
+PRODUCT_PACKAGES += \
+    VoiceDialer \
+    SoundRecorder \
+    Basic \
+    Galaxy4 \
+    LiveWallpapers \
+    LiveWallpapersPicker \
+    PhaseBeam
+
+# Custom CM packages
+PRODUCT_PACKAGES += \
+    Trebuchet \
+    DSPManager \
+    libcyanogen-dsp \
+    audio_effects.conf \
+    CMFileManager \
+    CMWallpapers \
+    Music \
+    Apollo
+
+# Extra tools in CM
+PRODUCT_PACKAGES += \
+    openvpn \
+    e2fsck \
+    mke2fs \
+    tune2fs
+
+PRODUCT_PACKAGE_OVERLAYS += vendor/cm/overlay/dictionaries
+PRODUCT_PACKAGE_OVERLAYS += vendor/cm/overlay/common
+
+PRODUCT_VERSION_MAJOR = 9
+PRODUCT_VERSION_MINOR = 1
+PRODUCT_VERSION_MAINTENANCE = 5
+PRODUCT_VERSION_DEVICE_SPECIFIC = -MMB_ICS
+
+CM_BUILDTYPE := RELEASE
+
+ifdef CM_BUILDTYPE
+    ifdef CM_EXTRAVERSION
+        # Force build type to EXPERIMENTAL
+        CM_BUILDTYPE := EXPERIMENTAL
+        # Add leading dash to CM_EXTRAVERSION
+        CM_EXTRAVERSION := -$(CM_EXTRAVERSION)
+    endif
+else
+    # If CM_BUILDTYPE is not defined, set to UNOFFICIAL
+    CM_BUILDTYPE := UNOFFICIAL
+    CM_EXTRAVERSION :=
+endif
+
+CM_VERSION := $(PRODUCT_VERSION_MAJOR).$(PRODUCT_VERSION_MINOR).$(PRODUCT_VERSION_MAINTENANCE)$(PRODUCT_VERSION_DEVICE_SPECIFIC)-$(CM_BUILD)
+
+PRODUCT_PROPERTY_OVERRIDES += \
+  ro.cm.version=$(CM_VERSION) \
+  ro.modversion=$(CM_VERSION)
diff --git a/config/common_mini_phone.mk b/config/common_mini_phone.mk
index 43bbe61..7ca1b5a 100644
--- a/config/common_mini_phone.mk
+++ b/config/common_mini_phone.mk
@@ -1,17 +1,17 @@
 # Inherit common CM stuff
-$(call inherit-product, vendor/cm/config/common.mk)
+$(call inherit-product, vendor/cm/config/common_mini.mk)
 
 # Bring in all audio files
-include frameworks/base/data/sounds/NewAudio.mk
+include frameworks/base/data/sounds/OldAudio.mk
 
 # Include CM audio files
-include vendor/cm/config/cm_audio.mk
+#include vendor/cm/config/cm_audio.mk
 
 # Default ringtone
 PRODUCT_PROPERTY_OVERRIDES += \
-    ro.config.ringtone=CyanTone.ogg \
-    ro.config.notification_sound=CyanMessage.ogg \
-    ro.config.alarm_alert=CyanAlarm.ogg
+    ro.config.ringtone=Ring_Digital_02.ogg \
+    ro.config.notification_sound=F1_New_SMS.ogg \
+    ro.config.alarm_alert=Alarm_Beep_03.ogg
 
 PRODUCT_PACKAGES += \
   Mms
diff --git a/get-prebuilts b/get-prebuilts
index 2d88b48..215f292 100755
--- a/get-prebuilts
+++ b/get-prebuilts
@@ -1,4 +1,3 @@
-
 BASEDIR=`dirname $0`
 
 mkdir -p $BASEDIR/proprietary
@@ -6,4 +5,3 @@ mkdir -p $BASEDIR/proprietary
 # Get Android Terminal Emulator (we use a prebuilt so it can update from the Market)
 curl -L -o $BASEDIR/proprietary/Term.apk -O -L http://jackpal.github.com/Android-Terminal-Emulator/downloads/Term.apk
 unzip -o -d $BASEDIR/proprietary $BASEDIR/proprietary/Term.apk lib/armeabi/libjackpal-androidterm4.so
-
diff --git a/jenkins-build-targets b/jenkins-build-targets
index cf9dfe1..fd5379b 100644
--- a/jenkins-build-targets
+++ b/jenkins-build-targets
@@ -1,15 +1,5 @@
-cm_aoba-userdebug
-cm_c800-userdebug
-cm_doubleshot-userdebug
-cm_e400-userdebug
-cm_e730-userdebug
-cm_e739-userdebug
-cm_hikari-userdebug
-cm_nozomi-userdebug
-cm_p5-userdebug
-cm_p5wifi-userdebug
-cm_pyramid-userdebug
-cm_shooteru-userdebug
-cm_tenderloin-userdebug
-cm_zeus-userdebug
-cm_zeusc-userdebug
+cm_beni-userdebug
+cm_cooper-userdebug
+cm_galaxy5-userdebug
+cm_gio-userdebug
+cm_tass-userdebug
diff --git a/prebuilt/common/etc/init.local.rc b/prebuilt/common/etc/init.local.rc
index 2a31cc3..407158a 100644
--- a/prebuilt/common/etc/init.local.rc
+++ b/prebuilt/common/etc/init.local.rc
@@ -5,11 +5,6 @@ on init
     export TERMINFO /system/etc/terminfo
     export TERM linux
 
-on post-fs-data
-    mkdir /cache/dalvik-cache 0771 system system
-    chown system system /cache/dalvik-cache
-    chmod 0771 /cache/dalvik-cache
-
 on boot
     chown system system /sys/block/mmcblk0/queue/scheduler
     chmod 0664 /sys/block/mmcblk0/queue/scheduler
@@ -24,17 +19,8 @@ on boot
     write /sys/kernel/mm/ksm/sleep_millisecs 1500
     write /sys/kernel/mm/ksm/pages_to_scan 256
 
-# adb over network
-on property:service.adb.tcp.port=5555
-    stop adbd
-    start adbd
-on property:service.adb.tcp.port=-1
-    stop adbd
-    start adbd
-
 # Compcache - handle at boot
 service compcache /system/bin/handle_compcache
-    class main
     user root
     group root
     oneshot
diff --git a/tools/squisher b/tools/squisher
index 552929f..c97ba9c 100755
--- a/tools/squisher
+++ b/tools/squisher
@@ -39,8 +39,15 @@ OPTICHARGER=$ANDROID_BUILD_TOP/vendor/cm/tools/opticharger
 QUIET=-q
 DELETE_BINS="applypatch applypatch_static check_prereq recovery updater"
 
+# If we have GApps we must delete some
+if [ -f "$OUT/system/app/SetupWizard.apk" ]; then
+echo "This is a GApps build!"
+DELETE_APKS="Provision.apk QuickSearchBox.apk Gallery2.apk"
+fi
+
 REPACK=$OUT/repack.d
 printf "Sanitizing environment..."
+rm -rf $OUT/cm-*.zip*
 rm -rf $REPACK
 mkdir -p $REPACK
 echo
@@ -68,6 +75,11 @@ $SED -i \
 
 # Delete unnecessary binaries
 ( cd $REPACK/ota/system/bin; echo $DELETE_BINS | xargs rm -f; )
+# ... and some app, if we have GApps
+if [ -f "$OUT/system/app/SetupWizard.apk" ]; then
+echo "Deleting conflicting apps..."
+( cd $REPACK/ota/system/app; echo $DELETE_APKS | xargs rm -f; )
+fi
 
 # No need for recovery
 rm -rf $REPACK/ota/recovery
@@ -77,7 +89,7 @@ rm -rf $REPACK/ota/recovery
 	find $REPACK/ota/system/lib/modules -name "*.ko" -print0 | xargs -0 arm-eabi-strip --strip-unneeded
 
 # Determine what to name the new signed package
-MODVERSION=`sed -n -e'/ro\.cm\.version/s/^.*=//p' $REPACK/ota/system/build.prop`
+MODVERSION=`sed -n -e'/ro\.cm\.version/s/^.*=//p' $REPACK/ota/system/build.prop`_`date +%Y%m%d-%k%M`
 OUTFILE=$OUT/cm-$MODVERSION.zip
 echo MODVERSION: $MODVERSION
 
diff --git a/vendorsetup.sh b/vendorsetup.sh
index 721e05d..aede0f6 100644
--- a/vendorsetup.sh
+++ b/vendorsetup.sh
@@ -1,4 +1,4 @@
-for combo in $(wget -o /dev/null -O - https://raw.github.com/CyanogenMod/hudson/master/cm-build-targets | grep ics | awk {'print $1'})
+for combo in $(cat vendor/cm/jenkins-build-targets)
 do
     add_lunch_combo $combo
 done
-- 
1.8.3.2

