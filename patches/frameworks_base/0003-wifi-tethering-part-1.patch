From 85d646d99aeeaa0da99ca6081e1d607da8c740da Mon Sep 17 00:00:00 2001
From: Giovanni Santini <giovannisantini93@yahoo.it>
Date: Mon, 11 May 2015 22:10:42 +0200
Subject: [PATCH] Wifi Tethering [1/3]

Change-Id: I1029ecd30635ebbd2e1ccfa3616f00d48be38ec4
---
 wifi/java/android/net/wifi/WifiStateMachine.java |   11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/wifi/java/android/net/wifi/WifiStateMachine.java b/wifi/java/android/net/wifi/WifiStateMachine.java
index ce1ad1d..2bf2bd6 100644
--- a/wifi/java/android/net/wifi/WifiStateMachine.java
+++ b/wifi/java/android/net/wifi/WifiStateMachine.java
@@ -110,8 +110,9 @@ public class WifiStateMachine extends StateMachine {
     private static final String NETWORKTYPE = "WIFI";
     private static final boolean DBG = false;
 
-    /* TODO: This is no more used with the hostapd code. Clean up */
+    /* TODO: This is no more used with the hostapd code. Clean up
     private static final String SOFTAP_IFACE = "wl0.1";
+    */
 
     private WifiMonitor mWifiMonitor;
     private WifiNative mWifiNative;
@@ -132,6 +133,7 @@ public class WifiStateMachine extends StateMachine {
     private final boolean mBackgroundScanSupported;
 
     private String mInterfaceName;
+    private String mSoftapInterfaceName;
     /* Tethering interface could be seperate from wlan interface */
     private String mTetherInterfaceName;
 
@@ -563,6 +565,7 @@ public class WifiStateMachine extends StateMachine {
 
         mContext = context;
         mInterfaceName = wlanInterface;
+        mSoftapInterfaceName = SystemProperties.get("wifi.ap.interface", mInterfaceName);
 
         mNetworkInfo = new NetworkInfo(ConnectivityManager.TYPE_WIFI, 0, NETWORKTYPE, "");
         mBatteryStats = IBatteryStats.Stub.asInterface(ServiceManager.getService("batteryinfo"));
@@ -1809,12 +1812,12 @@ public class WifiStateMachine extends StateMachine {
         new Thread(new Runnable() {
             public void run() {
                 try {
-                    mNwService.startAccessPoint(config, mInterfaceName, SOFTAP_IFACE);
+                    mNwService.startAccessPoint(config, mInterfaceName, mSoftapInterfaceName);
                 } catch (Exception e) {
                     loge("Exception in softap start " + e);
                     try {
                         mNwService.stopAccessPoint(mInterfaceName);
-                        mNwService.startAccessPoint(config, mInterfaceName, SOFTAP_IFACE);
+                        mNwService.startAccessPoint(config, mInterfaceName, mSoftapInterfaceName);
                     } catch (Exception e1) {
                         loge("Exception in softap re-start " + e1);
                         sendMessage(CMD_START_AP_FAILURE);
@@ -3696,7 +3699,7 @@ public class WifiStateMachine extends StateMachine {
 
                     /* We have not tethered at this point, so we just shutdown soft Ap */
                     try {
-                        mNwService.stopAccessPoint(mInterfaceName);
+                        mNwService.stopAccessPoint(mSoftapInterfaceName);
                     } catch(Exception e) {
                         loge("Exception in stopAccessPoint()");
                     }
-- 
1.7.9.5

